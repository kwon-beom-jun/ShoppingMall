<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">

<!--
    TODO : Thymeleaf 표현식과 지시어

    {} (Selection Variable Expressions)
        - 이 표현식은 선택된 객체에 대한 속성 값을 표현하기 위해 사용
        - 일반적으로 th:object 속성과 함께 사용되며, 선택된 객체의 속성에 직접 접근할 수 있게 해줌
        - 예를 들어, th:object="${myObject}"라는 객체가 있다면, *{name}은 myObject.getName()에 해당

    ${} (Variable Expressions)
        - 이 표현식은 컨텍스트 변수에 접근할 때 사용
        - 주로 모델 속성을 HTML에 삽입할 때 사용되며, 타임리프에서 가장 일반적으로 사용되는 표현식 중 하나
        - 예를 들어, 모델에 name이라는 속성이 있다면, ${name}을 통해 이 속성의 값을 출력할 수 있음

    ${#} (Utility Objects)
        - `${#}` 표현식은 타임리프에서 제공하는 유틸리티 객체에 접근할 때 사용
        - 이 유틸리티 객체들은 문자열 처리, 날짜 처리, 컬렉션 처리 등 다양한 기능을 제공
        - 예를 들어,
            1. ${#strings.toUpperCase(name)}은 name 변수의 값을 대문자로 변환하는 데 사용
            2. fields.hasErrors는 주로 Spring MVC와 함께 사용되는 타임리프(Thymeleaf)의 기능으로,
               특정 필드에 오류가 있는지 여부를 확인하는 데 사용

    ${#fields.hasErrors('')}
        - #fields.hasErrors는 Thymeleaf 템플릿 엔진에서 사용되는 표현식, 이 표현식은 Thymeleaf가 제공하는 기능 중 하나로,
          주로 Spring MVC의 BindingResult 객체와 함께 사용
        - #fields은 Thymeleaf의 표현식에서 객체의 필드에 접근하는 방법
        - #fields 다음에 오는 .hasErrors는 실제로 BindingResult 객체에 있는 hasErrors() 메소드를 호출
        - 예를 들어, ${#fields.hasErrors('username')}는 'username' 필드에 에러가 있는지를 확인
          빈 문자열('')을 사용하면 현재 객체의 모든 필드에 대한 에러가 있는지를 확인

    th:block
        - th:block은 타임리프에서 그룹화를 위한 목적으로 사용되는 더미 태그
        - 이 태그 자체는 브라우저에서 렌더링되지 않으며, 주로 템플릿 내에서 여러 요소에 동일한 조건이나
          반복을 적용할 때 유용
        - 타임리프 특성상 HTML 태그안에 속성으로 기능을 정의하여 사용하는데, 마땅한 html 태그가 없을 시 사용

    th:inline
        - th:inline은 스크립트나 스타일 시트 안에서 타임리프 표현식을 직접 사용할 수 있도록 해줌
        - 예를 들어, JavaScript 코드 안에서 타임리프 변수를 직접 쓸 수 있게 하려면 th:inline="javascript"를 사용
          내부에서 타임리프 변수를 사용할 때 [[${변수}]]로 사용

    th:errors
        - th:errors는 주로 폼 검증(validation)이 실패했을 때 발생하는 오류 메시지를 표시하는 데 사용
        - Spring MVC와 같은 프레임워크와 함께 사용될 때, 컨트롤러에서 BindingResult 또는 Errors 객체에
          추가된 오류 메시지를 표시하는 데 유용
        - 예를 들어, <div th:errors="*{fieldName}">와 같이 사용하면, fieldName에 대한 검증 오류가
          있을 때 이를 해당 위치에 표시

    th:value
        - th:value는 폼 필드의 값을 설정하는 데 사용
        - 주로 <input>, <select>, <textarea>와 같은 HTML 폼 요소에 적용
        - 이 지시어는 타임리프가 서버 사이드에서 생성한 데이터를 HTML 폼 요소의 값으로 채우는 데 사용되며,
          이를 통해 폼의 데이터를 미리 채울 수 있음
        - 예를 들어, <input type="text" th:value="${user.name}" />는 user 객체의 name 속성 값을 입력 필드에 미리 채움

    th:object
        - Thymeleaf에서 모델 객체를 지정할 때 사용
        - 객체 내부의 변수들을 접근하고 사용할 수 있음
        - 주로 form과 같은 HTML 태그에서 사용되며, 이를 통해 컨트롤러에서 전달된 데이터 객체를 form 내부에서 바인딩
        - 예를 들어, th:object="${myObject}"라고 지정하면, myObject라는 이름의 객체가 form 태그 내에서 사용되고,
          th:field="*{ myObject 내부의 변수이름 }"으로 사용됨

    th:field
         - 타임리프(Thymeleaf)를 사용하는 웹 애플리케이션에서 폼 필드를 쉽게 바인딩할 수 있게 해주는 속성
         - 주로 Spring MVC와 같은 웹 프레임워크와 함께 사용되며, 서버 사이드의 모델 객체와 HTML 폼 필드 간의 연결을 자동화
         - HTML form field(예: <input>, <select>, <textarea> 등)에 서버 사이드 모델의 특정 속성을 연결
         - form을 제출할 때, th:field로 바인딩된 폼 필드의 데이터는 자동으로 모델 객체에 매핑
         - 오류 메시지는 주로 th:errors를 사용하여 해당 필드 근처에 표시


    TODO : HTML form CSRF(Corss Site Request Forgery)

    CRSF란?
        - 사용자의 세션이나 쿠키, 헤더 등 임의의 값을 저장하여 전송하면 서버에 저장된 사용자의 임의의 값과 일치하는지 확인
        - 스프링 시큐리티를 사용할 경우 기본적으로 CSRF를 방어하기 위해 모든 POST 방식의 데이터 전송에는 CSRF 토큰 값이
          있어야 함
        - 실제 서버에서 허용한 요청이 맞는지 확인하는 토큰

    Spring Security의 CSRF 보호 메커니즘
        자동 토큰 생성
            Spring Security는 사용자의 세션마다 고유한 CSRF 토큰을 자동으로 생성
            이 토큰은 각 요청이 해당 사용자에 의해 의도적으로 만들어진 것임을 확인하는 데 사용
        토큰 전달
            CSRF 토큰은 주로 폼 데이터 또는 AJAX 요청을 통해 클라이언트(브라우저)에 전달
            이를 위해 Spring Security는 _csrf라는 객체를 제공
        토큰 사용
            클라이언트 측에서는 이 토큰을 폼에 숨겨진 필드로 추가하거나, HTTP 요청 헤더에 포함하여 서버로 전송
        요청 검증
            서버 측에서는 들어오는 모든 요청에 대해 포함된 CSRF 토큰을 검증
            토큰이 유효하고 세션에 저장된 토큰과 일치하면 요청을 수락하고, 그렇지 않으면 요청을 거부

    _csrf
        - Spring Security에서 생성하고 관리하는 객체
        - 예를 들어,
            토큰 값 (_csrf.token): 실제 CSRF 토큰의 값
            토큰의 파라미터 이름 (_csrf.parameterName): 폼 데이터나 HTTP 요청에서 사용되는 토큰의 이름
-->

<!-- 사용자 CSS 추가 -->
<th:block layout:fragment="css">
    <style>
        .fieldError {
            color: #bd2130;
        }
    </style>
</th:block>

<!-- 사용자 스크립트 추가 -->
<th:block layout:fragment="script">

    <!-- 회원 가입 실패하면 에러 메시지 경고창 -->
    <script th:inline="javascript">
        $(document).ready(function(){
            var errorMessage = [[${errorMessage}]];
            if(errorMessage != null){
                alert(errorMessage);
            }
        });
    </script>

</th:block>

<div layout:fragment="content">

    <form action="/members/new" role="form" method="post"  th:object="${memberFormDto}">
        <div class="form-group">
            <label th:for="name">이름</label>
            <input type="text" th:field="*{name}" class="form-control" placeholder="이름을 입력해주세요">
            <p th:if="${#fields.hasErrors('name')}" th:errors="*{name}" class="fieldError">Incorrect data</p>
        </div>
        <div class="form-group">
            <label th:for="email">이메일주소</label>
            <input type="email" th:field="*{email}" class="form-control" placeholder="이메일을 입력해주세요">
            <p th:if="${#fields.hasErrors('email')}" th:errors="*{email}" class="fieldError">Incorrect data</p>
        </div>
        <div class="form-group">
            <label th:for="password">비밀번호</label>
            <input type="password" th:field="*{password}" class="form-control" placeholder="비밀번호 입력">
            <p th:if="${#fields.hasErrors('password')}" th:errors="*{password}" class="fieldError">Incorrect data</p>
        </div>
        <div class="form-group">
            <label th:for="address">주소</label>
            <input type="text" th:field="*{address}" class="form-control" placeholder="주소를 입력해주세요">
            <p th:if="${#fields.hasErrors('address')}" th:errors="*{address}" class="fieldError">Incorrect data</p>
        </div>
        <div style="text-align: center">
            <button type="submit" class="btn btn-primary" style="">Submit</button>
        </div>
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
    </form>

</div>

</html>